#!/bin/bash
set -e

# ---- Функция установки конфигурации ----
set_config() {
    # ---- Функция вывода заголовков секций ----
    log_section() {
        local BLUE="\033[34m"
        local CLEAR="\033[0m"
        printf "%b===> %s%b\n" "$BLUE" "$*" "$CLEAR"
    }

    # ---- Список подавляемых предупреждений ----
    SUPPRESS_PATTERNS=(
        "Possible precedence problem"
        "Duplicate specification"
        "mismatched end line"
        "unsupported"
        "format"
        "inconsistent"
        "(empty) no data generated"
        "use \"lcov --ignore-errors empty"
        "Excluding "
        "Removed "
    )

    # ---- Функция фильтрации вывода ----
    filter_output() {
        local line
        while IFS= read -r line; do
            local skip=0
            for pat in "${SUPPRESS_PATTERNS[@]}"; do
                [[ "$line" == *"$pat"* ]] && skip=1 && break
            done
            (( skip == 0 )) && echo "$line"
        done
    }

    cd "$(dirname "$0")"
}

# ---- Запуск тестов ----
run_tests() {
    log_section "Running unit tests..."
    ctest --output-on-failure
}

# ---- Сбор сырых данных покрытия ----
capture_coverage() {
    log_section "Capturing raw coverage..."
    # ---- Выполняем lcov, фильтруем вывод ----
    lcov --capture --directory . \
        --output-file coverage_raw.info \
        --ignore-errors mismatch,source,empty,gcov,inconsistent,unsupported,format \
        2>&1 | filter_output || true
}

# ---- Сбор списка файлов проекта для покрытия ----
collect_files() {
    log_section "Collecting coverage file list..."
    PROJECT_ROOT="$(readlink -f ..)"    # корень проекта
    args=()
    short_list=()
    while IFS= read -r f; do
        [[ -z "$f" ]] && continue
        # Преобразуем абсолютный путь → относительный
        rel="${f#"${PROJECT_ROOT}"/}"
        args+=("$f")          # полный путь — нужен для lcov
        short_list+=("$rel")  # относительный — для красивого вывода
    done < "@COVERAGE_LIST_FILE@"
    # Показываем относительные пути
    printf '  %s\n' "${short_list[@]}"
}

# ---- Извлечение и фильтрация данных покрытия ----
filter_coverage() {
    log_section "Filtering coverage..."
    lcov --extract coverage_raw.info \
        "${args[@]}" \
        --output-file coverage.info \
        --ignore-errors unused,mismatch \
        2>&1 | filter_output
}

# ---- Генерация HTML отчета ----
generate_html() {
    log_section "Generating HTML report..."
    genhtml coverage.info --output-directory out --flat
}

# ---- Открытие HTML отчета в браузере ----
open_report() {
    log_section "Opening coverage report..."
    printf '  %s\n' "out/index.html"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        open out/index.html >/dev/null 2>&1 || true
    else
        xdg-open out/index.html >/dev/null 2>&1 || true
    fi
}

main() {
    set_config
    run_tests
    capture_coverage
    collect_files
    filter_coverage
    generate_html
    open_report
}

main "$@"