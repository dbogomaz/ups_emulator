#!/bin/bash
set -e

RED="\033[31m"
GREEN="\033[32m"
BLUE="\033[34m"
YELLOW="\033[33m"
CLEAR="\033[0m"

# ---- Список подавляемых предупреждений ----
SUPPRESS_PATTERNS=(
    "Possible precedence problem"
    "Duplicate specification"
    "mismatched end line"
    "unsupported"
    "format"
    "inconsistent"
    "(empty) no data generated"
    "use \"lcov --ignore-errors empty"
    "Excluding "
    "Removed "
)

# ---- Функция фильтрации вывода ----
filter_output() {
    local line
    while IFS= read -r line; do
        local skip=0
        for pat in "${SUPPRESS_PATTERNS[@]}"; do
            [[ "$line" == *"$pat"* ]] && skip=1 && break
        done
        (( skip == 0 )) && echo "$line"
    done
}

cd "$(dirname "$0")"



printf "${BLUE}===> Running unit tests...\n${CLEAR}"
ctest --output-on-failure



printf "${BLUE}===> Capturing raw coverage...\n${CLEAR}"
# ---- Выполняем lcov, фильтруем вывод ----
lcov --capture --directory . \
     --output-file coverage_raw.info \
     --ignore-errors mismatch,source,empty,gcov,inconsistent,unsupported,format \
     2>&1 | filter_output || true



printf "${BLUE}===> Collecting coverage file list...\n${CLEAR}"
PROJECT_ROOT="$(readlink -f ..)"    # корень проекта
args=()
short_list=()
while IFS= read -r f; do
    [[ -z "$f" ]] && continue
    # Преобразуем абсолютный путь → относительный
    rel="${f#"${PROJECT_ROOT}"/}"
    args+=("$f")          # полный путь — нужен для lcov
    short_list+=("$rel")  # относительный — для красивого вывода
done < "@COVERAGE_LIST_FILE@"
# Показываем относительные пути
printf '  %s\n' "${short_list[@]}"



printf "${BLUE}===> Filtering coverage (project sources only)...\n${CLEAR}"
lcov --extract coverage_raw.info \
     "${args[@]}" \
     --output-file coverage.info \
     --ignore-errors unused \
     --ignore-errors mismatch \
     2>&1 | filter_output



printf "${BLUE}===> Generating HTML report...\n${CLEAR}"
genhtml coverage.info --output-directory out --flat



printf "${GREEN}===> Coverage report generated: out/index.html\n${CLEAR}"
if [[ "$OSTYPE" == "darwin"* ]]; then
    open out/index.html >/dev/null 2>&1 || true
else
    xdg-open out/index.html >/dev/null 2>&1 || true
fi
